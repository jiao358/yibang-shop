# 微信支付提现集成文档

## 概述

本文档描述如何在任务商城平台中集成微信支付的企业付款到零钱功能，实现用户提现到微信钱包的完整流程。

## 业务流程

### 1. 用户提现申请流程

```
用户发起提现申请 → 系统校验用户余额 → 冻结提现金额 → 创建提现记录 → 工作人员审核 → 微信支付打款 → 更新提现状态
```

### 2. 状态流转

- **pending**: 待审核（用户刚提交申请）
- **processing**: 审核通过，正在处理微信支付
- **completed**: 打款成功
- **failed**: 打款失败
- **cancelled**: 已取消

## 技术架构

### 1. 数据库设计

```sql
-- 提现记录表（使用withdrawals表）
CREATE TABLE `withdrawals` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '提现ID',
  `user_id` bigint(20) NOT NULL COMMENT '用户ID',
  `amount` int(11) NOT NULL COMMENT '提现金额（分）',
  `status` varchar(20) DEFAULT 'pending' COMMENT '提现状态',
  `withdrawal_type` varchar(20) DEFAULT 'wechat_pay' COMMENT '提现方式',
  `wechat_transaction_id` varchar(100) DEFAULT NULL COMMENT '微信交易单号',
  `wechat_payment_no` varchar(100) DEFAULT NULL COMMENT '微信支付单号',
  `failure_reason` varchar(500) DEFAULT NULL COMMENT '失败原因',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `processed_at` timestamp NULL DEFAULT NULL COMMENT '处理完成时间',
  `completed_at` timestamp NULL DEFAULT NULL COMMENT '完成时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='提现记录表';
```

### 2. 微信支付配置

需要在微信商户平台配置以下信息：

```yaml
wechat:
  pay:
    appId: wx1234567890123456  # 小程序AppID
    mchId: 1234567890  # 商户号
    apiV3Key: your-api-v3-key-32-characters  # APIv3密钥
    privateKeyPath: /path/to/apiclient_key.pem  # 商户私钥路径
    certSerialNo: 1234567890ABCDEF1234567890ABCDEF12345678  # 证书序列号
    apiHost: https://api.mch.weixin.qq.com  # 微信支付API域名
```

### 3. 核心接口

#### 3.1 企业付款到零钱 API

**接口地址**: `POST https://api.mch.weixin.qq.com/v3/transfer/batches`

**请求参数**:
```json
{
  "appid": "wx1234567890123456",
  "out_batch_no": "batch_" + timestamp,
  "batch_name": "用户提现",
  "batch_remark": "任务商城用户提现",
  "total_amount": 10000,
  "total_num": 1,
  "transfer_detail_list": [
    {
      "out_detail_no": "detail_" + timestamp,
      "transfer_amount": 10000,
      "transfer_remark": "提现到微信零钱",
      "openid": "o4GgauInH_RCEdvrrNGrntQDuAjQ"
    }
  ]
}
```

#### 3.2 查询批次单 API

**接口地址**: `GET https://api.mch.weixin.qq.com/v3/transfer/batches/out-batch-no/{out_batch_no}`

**用途**: 查询提现批次状态，确认是否成功

### 4. 安全要求

#### 4.1 签名验证

微信支付APIv3使用证书和私钥进行签名验证：

```java
// 示例：构建签名字符串
String timestamp = String.valueOf(System.currentTimeMillis() / 1000);
String nonce = UUID.randomUUID().toString().replace("-", "");
String url = "/v3/transfer/batches";
String body = requestJson;

String message = method + "\n" + url + "\n" + timestamp + "\n" + nonce + "\n" + body + "\n";
String signature = sign(message, privateKey);

String authorization = "WECHATPAY2-SHA256-RSA2048 " +
    "mchid=\"" + mchId + "\"," +
    "nonce_str=\"" + nonce + "\"," +
    "timestamp=\"" + timestamp + "\"," +
    "serial_no=\"" + certSerialNo + "\"," +
    "signature=\"" + signature + "\"";
```

#### 4.2 回调验证

验证微信支付回调的合法性：

```java
// 验证签名
public boolean verifyCallback(String timestamp, String nonce, String body, String signature) {
    String message = timestamp + "\n" + nonce + "\n" + body + "\n";
    return verifySignature(message, signature, wechatPublicKey);
}
```

### 5. 实现示例

#### 5.1 提现服务实现

```java
@Service
public class WechatPaymentService {
    
    @Value("${wechat.pay.mchId}")
    private String mchId;
    
    @Value("${wechat.pay.appId}")
    private String appId;
    
    public TransferResult transferToWallet(WithdrawalRequest request) {
        try {
            // 1. 构建请求参数
            TransferBatchRequest batchRequest = buildTransferRequest(request);
            
            // 2. 发送请求到微信支付
            String response = sendRequest("/v3/transfer/batches", batchRequest);
            
            // 3. 解析响应
            TransferBatchResponse batchResponse = parseResponse(response);
            
            // 4. 更新本地记录
            updateWithdrawalRecord(request.getWithdrawalId(), batchResponse);
            
            return TransferResult.success(batchResponse.getBatchId());
            
        } catch (Exception e) {
            log.error("微信支付转账失败: {}", e.getMessage(), e);
            return TransferResult.failure(e.getMessage());
        }
    }
}
```

#### 5.2 回调处理

```java
@PostMapping("/wechat/pay/callback")
public void handleCallback(@RequestBody String requestBody, HttpServletRequest request) {
    try {
        // 1. 验证签名
        if (!verifyCallback(request)) {
            throw new SecurityException("签名验证失败");
        }
        
        // 2. 解析回调数据
        CallbackData data = parseCallbackData(requestBody);
        
        // 3. 更新提现状态
        updateWithdrawalStatus(data);
        
        // 4. 发送用户通知
        notifyUser(data);
        
    } catch (Exception e) {
        log.error("处理微信支付回调失败", e);
    }
}
```

### 6. 错误处理

#### 6.1 常见错误码

| 错误码 | 描述 | 处理方式 |
|--------|------|----------|
| INVALID_REQUEST | 请求参数错误 | 检查请求参数格式 |
| INSUFFICIENT_FUNDS | 商户余额不足 | 提醒管理员充值 |
| FREQUENCY_LIMITED | 请求频率超限 | 延迟重试 |
| OPENID_ERROR | openid错误 | 检查用户微信信息 |

#### 6.2 重试机制

```java
@Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
public TransferResult transferWithRetry(WithdrawalRequest request) {
    return transferToWallet(request);
}
```

### 7. 监控告警

#### 7.1 关键指标

- 提现成功率
- 平均处理时间
- 失败原因分布
- 商户余额预警

#### 7.2 日志记录

```java
// 记录关键操作日志
log.info("提现申请: userId={}, amount={}, withdrawalId={}", 
    request.getUserId(), request.getAmount(), request.getWithdrawalId());

log.info("微信支付请求: batchNo={}, amount={}", 
    batchNo, totalAmount);

log.info("提现完成: withdrawalId={}, wechatBatchId={}, status={}", 
    withdrawalId, batchId, status);
```

### 8. 测试方案

#### 8.1 单元测试

测试各个组件的功能：

- 签名生成和验证
- 请求参数构建
- 响应解析
- 状态更新逻辑

#### 8.2 集成测试

使用微信支付沙箱环境进行测试：

- 小额转账测试
- 异常情况模拟
- 回调处理验证

### 9. 部署注意事项

#### 9.1 证书管理

- 安全存储商户私钥
- 定期更新证书
- 证书权限控制

#### 9.2 配置管理

- 敏感信息加密存储
- 环境隔离配置
- 配置变更审批流程

### 10. 运维监控

#### 10.1 实时监控

- 提现处理队列长度
- 微信支付API响应时间
- 错误率监控

#### 10.2 定期检查

- 对账文件校验
- 资金流水核对
- 异常交易排查

## 总结

微信支付提现功能涉及资金安全，需要严格按照微信支付规范实现。重点关注：

1. **安全性**: 签名验证、证书管理、敏感信息保护
2. **可靠性**: 重试机制、异常处理、状态管理
3. **监控性**: 日志记录、告警机制、对账核验
4. **合规性**: 遵循微信支付接口规范和风控要求

建议分阶段实施：
1. 第一阶段：基础功能实现和测试
2. 第二阶段：监控告警和异常处理完善
3. 第三阶段：性能优化和安全加固

---

**文档版本**: v1.0  
**创建时间**: 2024-01-15  
**维护人员**: 开发团队
