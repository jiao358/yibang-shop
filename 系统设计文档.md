# 系统设计文档

## 1. 系统概述

### 1.1 系统架构
- **前端**：微信小程序
- **后端**：Java SpringBoot
- **数据库**：MySQL + Redis
- **外部集成**：ERP系统、微信支付、广告主平台

### 1.2 系统职责
- **任务管理**：任务创建、分配、完成验证
- **收益管理**：收益计算、分配、提现
- **用户管理**：用户等级、签约状态管理
- **商城集成**：与ERP系统集成，处理商品和订单

## 2. 功能模块设计

### 2.1 用户认证模块
**功能描述**：微信登录认证和用户信息管理

**核心功能**：
- 微信授权登录
- 用户信息获取和同步
- 登录状态管理
- 用户等级计算和更新

**API接口**：
```
POST /api/auth/wechat-login     # 微信登录
POST /api/auth/refresh-token    # 刷新Token
GET  /api/user/profile          # 获取用户信息
PUT  /api/user/level            # 更新用户等级
```

**Java Controller示例**：
```java
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    
    @PostMapping("/wechat-login")
    public ResponseEntity<LoginResponse> wechatLogin(@RequestBody WechatLoginRequest request) {
        // 微信登录逻辑
    }
    
    @PostMapping("/refresh-token")
    public ResponseEntity<TokenResponse> refreshToken(@RequestBody RefreshTokenRequest request) {
        // 刷新Token逻辑
    }
}
```

### 2.2 任务大厅模块
**功能描述**：任务展示、领取、完成管理

**核心功能**：
- 任务列表展示（按类型、等级筛选）
- 任务详情查看
- 任务领取和完成
- 任务状态跟踪

**API接口**：
```
GET  /api/tasks                 # 获取任务列表
GET  /api/tasks/{task_id}       # 获取任务详情
POST /api/user-tasks/claim      # 领取任务
POST /api/user-tasks/{id}/complete  # 完成任务
GET  /api/user-tasks            # 获取用户任务列表
```

**Java Controller示例**：
```java
@RestController
@RequestMapping("/api/tasks")
public class TaskController {
    
    @GetMapping
    public ResponseEntity<PageResult<TaskVO>> getTasks(
            @RequestParam(required = false) String type,
            @RequestParam(required = false) String userLevel,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size) {
        // 获取任务列表逻辑
    }
    
    @GetMapping("/{taskId}")
    public ResponseEntity<TaskDetailVO> getTaskDetail(@PathVariable Long taskId) {
        // 获取任务详情逻辑
    }
}

@RestController
@RequestMapping("/api/user-tasks")
public class UserTaskController {
    
    @PostMapping("/claim")
    public ResponseEntity<ClaimResult> claimTask(@RequestBody ClaimTaskRequest request) {
        // 领取任务逻辑
    }
    
    @PostMapping("/{id}/complete")
    public ResponseEntity<CompleteResult> completeTask(
            @PathVariable Long id, 
            @RequestBody CompleteTaskRequest request) {
        // 完成任务逻辑
    }
}
```

### 2.3 收益管理模块
**功能描述**：收益计算、统计、提现管理

**核心功能**：
- 收益统计和展示
- 提现申请和处理
- 收益明细记录
- 提现状态跟踪

**API接口**：
```
GET  /api/earnings/stats        # 获取收益统计
GET  /api/earnings/records      # 获取收益明细
POST /api/withdrawals/apply     # 申请提现
GET  /api/withdrawals           # 获取提现记录
POST /api/withdrawals/{id}/process  # 处理提现
```

**Java Controller示例**：
```java
@RestController
@RequestMapping("/api/earnings")
public class EarningsController {
    
    @GetMapping("/stats")
    public ResponseEntity<EarningsStatsVO> getEarningsStats(
            @RequestParam Long userId,
            @RequestParam String period) {
        // 获取收益统计逻辑
    }
    
    @GetMapping("/records")
    public ResponseEntity<PageResult<EarningsRecordVO>> getEarningsRecords(
            @RequestParam Long userId,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size) {
        // 获取收益明细逻辑
    }
}

@RestController
@RequestMapping("/api/withdrawals")
public class WithdrawalController {
    
    @PostMapping("/apply")
    public ResponseEntity<WithdrawalResult> applyWithdrawal(@RequestBody WithdrawalRequest request) {
        // 申请提现逻辑
    }
    
    @PostMapping("/{id}/process")
    public ResponseEntity<ProcessResult> processWithdrawal(
            @PathVariable Long id,
            @RequestBody ProcessWithdrawalRequest request) {
        // 处理提现逻辑
    }
}
```

### 2.4 商城集成模块
**功能描述**：与ERP系统集成，处理商品和订单

**核心功能**：
- 商品信息同步
- 订单下单处理
- 支付状态同步
- 物流信息跟踪

**API接口**：
```
GET  /api/mall/products         # 获取商品列表
GET  /api/mall/products/{id}    # 获取商品详情
POST /api/mall/orders           # 创建订单
GET  /api/mall/orders           # 获取订单列表
POST /api/mall/payment          # 处理支付
```

**Java Controller示例**：
```java
@RestController
@RequestMapping("/api/mall")
public class MallController {
    
    @GetMapping("/products")
    public ResponseEntity<PageResult<ProductVO>> getProducts(
            @RequestParam(required = false) String category,
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size) {
        // 获取商品列表逻辑
    }
    
    @GetMapping("/products/{id}")
    public ResponseEntity<ProductDetailVO> getProductDetail(@PathVariable Long id) {
        // 获取商品详情逻辑
    }
    
    @PostMapping("/orders")
    public ResponseEntity<OrderResult> createOrder(@RequestBody CreateOrderRequest request) {
        // 创建订单逻辑
    }
    
    @PostMapping("/payment")
    public ResponseEntity<PaymentResult> processPayment(@RequestBody PaymentRequest request) {
        // 处理支付逻辑
    }
}
```

### 2.5 通知模块
**功能描述**：系统通知和消息管理

**核心功能**：
- 任务完成通知
- 收益到账通知
- 等级提升通知
- 消息中心管理

**API接口**：
```
GET  /api/notifications         # 获取通知列表
POST /api/notifications/send    # 发送通知
PUT  /api/notifications/{id}/read  # 标记已读
```

**Java Controller示例**：
```java
@RestController
@RequestMapping("/api/notifications")
public class NotificationController {
    
    @GetMapping
    public ResponseEntity<PageResult<NotificationVO>> getNotifications(
            @RequestParam Long userId,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size) {
        // 获取通知列表逻辑
    }
    
    @PostMapping("/send")
    public ResponseEntity<SendResult> sendNotification(@RequestBody SendNotificationRequest request) {
        // 发送通知逻辑
    }
    
    @PutMapping("/{id}/read")
    public ResponseEntity<ReadResult> markAsRead(@PathVariable Long id) {
        // 标记已读逻辑
    }
}
```

## 3. 数据库设计

### 3.1 核心数据表

#### 任务表 (tasks)
```sql
CREATE TABLE tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL COMMENT '任务标题',
    description TEXT COMMENT '任务描述',
    type ENUM('ad', 'video', 'app_install') NOT NULL COMMENT '任务类型',
    reward_amount INT NOT NULL DEFAULT 0 COMMENT '奖励金额（分）',
    requirements JSON COMMENT '任务要求配置',
    user_level ENUM('normal', 'vip', 'premium', 'all') DEFAULT 'all' COMMENT '适用用户等级',
    status ENUM('active', 'inactive', 'completed') DEFAULT 'active' COMMENT '任务状态',
    expire_time TIMESTAMP NULL COMMENT '任务过期时间',
    max_claim_count INT DEFAULT -1 COMMENT '最大领取次数，-1表示无限制',
    current_claim_count INT DEFAULT 0 COMMENT '当前已领取次数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_type_status (type, status),
    INDEX idx_user_level (user_level),
    INDEX idx_expire_time (expire_time)
);
```

#### 用户任务表 (user_tasks)
```sql
CREATE TABLE user_tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID（来自ERP系统）',
    task_id BIGINT NOT NULL,
    status ENUM('claimed', 'completed', 'verified', 'expired', 'failed') DEFAULT 'claimed' COMMENT '任务状态',
    claimed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '领取时间',
    completed_at TIMESTAMP NULL COMMENT '完成时间',
    verified_at TIMESTAMP NULL COMMENT '验证时间',
    proof_data JSON COMMENT '完成凭证数据',
    reward_amount INT COMMENT '实际奖励金额（分）',
    failure_reason VARCHAR(500) COMMENT '失败原因',
    FOREIGN KEY (task_id) REFERENCES tasks(id),
    INDEX idx_user_status (user_id, status),
    INDEX idx_task_status (task_id, status),
    INDEX idx_claimed_at (claimed_at)
);
```

#### 收益记录表 (earnings)
```sql
CREATE TABLE earnings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID（来自ERP系统）',
    user_task_id BIGINT NULL COMMENT '关联的用户任务ID',
    amount INT NOT NULL COMMENT '收益金额（分）',
    type ENUM('task_reward', 'withdrawal', 'refund', 'bonus') NOT NULL COMMENT '收益类型',
    status ENUM('pending', 'completed', 'failed', 'cancelled') DEFAULT 'pending' COMMENT '收益状态',
    description VARCHAR(500) COMMENT '收益描述',
    source_task_title VARCHAR(200) COMMENT '来源任务标题',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP NULL COMMENT '处理完成时间',
    FOREIGN KEY (user_task_id) REFERENCES user_tasks(id),
    INDEX idx_user_type (user_id, type),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

#### 提现记录表 (withdrawals)
```sql
CREATE TABLE withdrawals (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID（来自ERP系统）',
    amount INT NOT NULL COMMENT '提现金额（分）',
    status ENUM('pending', 'processing', 'completed', 'failed', 'cancelled') DEFAULT 'pending' COMMENT '提现状态',
    wechat_transaction_id VARCHAR(100) COMMENT '微信交易单号',
    wechat_payment_no VARCHAR(100) COMMENT '微信支付单号',
    failure_reason VARCHAR(500) COMMENT '失败原因',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP NULL COMMENT '处理完成时间',
    completed_at TIMESTAMP NULL COMMENT '完成时间',
    INDEX idx_user_status (user_id, status),
    INDEX idx_created_at (created_at)
);
```

#### 用户等级配置表 (user_level_config)
```sql
CREATE TABLE user_level_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    level_name VARCHAR(50) NOT NULL COMMENT '等级名称',
    level_code ENUM('normal', 'vip', 'premium') NOT NULL COMMENT '等级代码',
    min_earnings INT DEFAULT 0 COMMENT '最低收益要求（分）',
    max_daily_withdrawal INT DEFAULT 0 COMMENT '每日最大提现金额（分），0表示无限制',
    withdrawal_fee_rate DECIMAL(5,4) DEFAULT 0.0000 COMMENT '提现手续费率',
    task_bonus_rate DECIMAL(5,4) DEFAULT 0.0000 COMMENT '任务奖励加成率',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_level_code (level_code)
);
```

### 3.2 数据表关系
- `tasks` ← `user_tasks` (一对多)
- `user_tasks` ← `earnings` (一对多)
- `user_level_config` → 用户等级配置

## 4. 技术架构

### 4.1 系统架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微信小程序     │    │   后端API服务    │    │   ERP系统       │
│                 │    │                 │    │                 │
│ - 用户界面      │◄──►│ - FastAPI       │◄──►│ - 用户管理      │
│ - 任务展示      │    │ - 任务管理      │    │ - 商品管理      │
│ - 收益管理      │    │ - 收益管理      │    │ - 订单管理      │
│ - 商城功能      │    │ - 支付集成      │    │ - 物流管理      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   外部服务      │
                       │                 │
                       │ - 微信支付      │
                       │ - 广告主平台    │
                       │ - 消息推送      │
                       └─────────────────┘
```

### 4.2 技术栈
- **前端**：微信小程序原生开发
- **后端**：Java SpringBoot 3.2.0
- **数据库**：MySQL 8.0 + Redis 6.0
- **消息队列**：RabbitMQ
- **支付**：微信支付API
- **部署**：Docker + Nginx
- **构建工具**：Maven
- **开发框架**：Spring Boot 3.2.0 + Spring Security + MyBatis Plus 3.5.9
- **Java版本**：Java 17
- **JWT**：jjwt 0.12.3
- **工具库**：Hutool 5.8.22
- **微信SDK**：weixin-java-miniapp 4.5.0
- **广告SDK**：穿山甲SDK 4.5.0.0

### 4.5 Maven依赖配置
```xml
<properties>
    <java.version>17</java.version>
    <maven.compiler.source>17</maven.compiler.source>
    <maven.compiler.target>17</maven.compiler.target>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <mybatis-plus.version>3.5.9</mybatis-plus.version>
    <jjwt.version>0.12.3</jjwt.version>
    <hutool.version>5.8.22</hutool.version>
    <wechat.version>4.5.0</wechat.version>
</properties>

<dependencies>
    <!-- Spring Boot 核心依赖 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-websocket</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-aop</artifactId>
    </dependency>
    
    <!-- 数据库相关 -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-spring-boot3-starter</artifactId>
        <version>${mybatis-plus.version}</version>
    </dependency>
    
    <!-- JWT认证 -->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-api</artifactId>
        <version>${jjwt.version}</version>
    </dependency>
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-impl</artifactId>
        <version>${jjwt.version}</version>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-jackson</artifactId>
        <version>${jjwt.version}</version>
        <scope>runtime</scope>
    </dependency>
    
    <!-- 微信相关 -->
    <dependency>
        <groupId>com.github.binarywang</groupId>
        <artifactId>weixin-java-miniapp</artifactId>
        <version>${wechat.version}</version>
    </dependency>
    <dependency>
        <groupId>com.github.binarywang</groupId>
        <artifactId>weixin-java-pay</artifactId>
        <version>${wechat.version}</version>
    </dependency>
    
    <!-- 工具库 -->
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>${hutool.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
    </dependency>
    
    <!-- 消息队列 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-amqp</artifactId>
    </dependency>
    
    <!-- 广告SDK -->
    <dependency>
        <groupId>com.bytedance</groupId>
        <artifactId>pangle-sdk</artifactId>
        <version>4.5.0.0</version>
    </dependency>
    
    <!-- 其他依赖 -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### 4.3 核心服务
- **任务服务**：任务管理、分配、验证
- **收益服务**：收益计算、分配、提现
- **用户服务**：用户等级、签约状态管理
- **支付服务**：微信支付集成
- **通知服务**：消息推送和通知管理

### 4.4 Maven项目结构
```
yibang-taskmall/
├── pom.xml                          # Maven配置文件
├── src/
│   ├── main/
│   │   ├── java/com/yibang/taskmall/
│   │   │   ├── TaskMallApplication.java          # 启动类
│   │   │   ├── config/                          # 配置类
│   │   │   │   ├── SecurityConfig.java          # 安全配置
│   │   │   │   ├── RedisConfig.java             # Redis配置
│   │   │   │   ├── WechatConfig.java            # 微信配置
│   │   │   │   ├── MybatisPlusConfig.java       # MyBatis Plus配置
│   │   │   │   └── RabbitMQConfig.java          # RabbitMQ配置
│   │   │   ├── controller/                      # 控制器层
│   │   │   │   ├── AuthController.java          # 认证控制器
│   │   │   │   ├── TaskController.java          # 任务控制器
│   │   │   │   ├── UserTaskController.java      # 用户任务控制器
│   │   │   │   ├── EarningsController.java      # 收益控制器
│   │   │   │   ├── WithdrawalController.java    # 提现控制器
│   │   │   │   ├── MallController.java          # 商城控制器
│   │   │   │   └── NotificationController.java  # 通知控制器
│   │   │   ├── service/                         # 服务层
│   │   │   │   ├── AuthService.java             # 认证服务
│   │   │   │   ├── TaskService.java             # 任务服务
│   │   │   │   ├── UserTaskService.java         # 用户任务服务
│   │   │   │   ├── EarningsService.java         # 收益服务
│   │   │   │   ├── WithdrawalService.java       # 提现服务
│   │   │   │   ├── MallService.java             # 商城服务
│   │   │   │   └── NotificationService.java     # 通知服务
│   │   │   ├── entity/                          # 实体类
│   │   │   │   ├── Task.java                    # 任务实体
│   │   │   │   ├── UserTask.java                # 用户任务实体
│   │   │   │   ├── Earnings.java                # 收益实体
│   │   │   │   ├── Withdrawal.java              # 提现实体
│   │   │   │   └── UserLevelConfig.java         # 用户等级配置实体
│   │   │   ├── dto/                             # 数据传输对象
│   │   │   │   ├── request/                     # 请求DTO
│   │   │   │   │   ├── WechatLoginRequest.java
│   │   │   │   │   ├── ClaimTaskRequest.java
│   │   │   │   │   ├── CompleteTaskRequest.java
│   │   │   │   │   └── WithdrawalRequest.java
│   │   │   │   └── response/                    # 响应DTO
│   │   │   │       ├── LoginResponse.java
│   │   │   │       ├── TaskResponse.java
│   │   │   │       └── EarningsResponse.java
│   │   │   ├── vo/                              # 视图对象
│   │   │   │   ├── TaskVO.java                  # 任务视图对象
│   │   │   │   ├── UserTaskVO.java              # 用户任务视图对象
│   │   │   │   └── EarningsVO.java              # 收益视图对象
│   │   │   ├── mapper/                          # 数据访问层
│   │   │   │   ├── TaskMapper.java              # 任务Mapper
│   │   │   │   ├── UserTaskMapper.java          # 用户任务Mapper
│   │   │   │   ├── EarningsMapper.java          # 收益Mapper
│   │   │   │   └── WithdrawalMapper.java        # 提现Mapper
│   │   │   ├── utils/                           # 工具类
│   │   │   │   ├── WechatUtils.java             # 微信工具类
│   │   │   │   ├── PaymentUtils.java            # 支付工具类
│   │   │   │   ├── NotificationUtils.java       # 通知工具类
│   │   │   │   └── JwtUtils.java                # JWT工具类
│   │   │   ├── common/                          # 公共类
│   │   │   │   ├── Result.java                  # 统一返回结果
│   │   │   │   ├── PageResult.java              # 分页结果
│   │   │   │   ├── Constants.java               # 常量类
│   │   │   │   └── GlobalExceptionHandler.java  # 全局异常处理
│   │   │   ├── exception/                       # 异常类
│   │   │   │   ├── BusinessException.java       # 业务异常
│   │   │   │   └── SystemException.java         # 系统异常
│   │   │   └── enums/                           # 枚举类
│   │   │       ├── TaskTypeEnum.java            # 任务类型枚举
│   │   │       ├── UserLevelEnum.java           # 用户等级枚举
│   │   │       └── EarningsTypeEnum.java        # 收益类型枚举
│   │   └── resources/
│   │       ├── application.yml                  # 应用配置
│   │       ├── application-dev.yml              # 开发环境配置
│   │       ├── application-prod.yml             # 生产环境配置
│   │       ├── mapper/                          # MyBatis映射文件
│   │       │   ├── TaskMapper.xml
│   │       │   ├── UserTaskMapper.xml
│   │       │   ├── EarningsMapper.xml
│   │       │   └── WithdrawalMapper.xml
│   │       └── static/                          # 静态资源
│   └── test/
│       └── java/com/yibang/taskmall/
│           ├── TaskMallApplicationTests.java    # 测试启动类
│           ├── controller/                      # 控制器测试
│           ├── service/                         # 服务测试
│           └── mapper/                          # 数据访问测试
└── README.md                                    # 项目说明文档
```

## 5. 接口设计

### 5.1 认证接口
```java
// 微信登录
@PostMapping("/wechat-login")
public ResponseEntity<LoginResponse> wechatLogin(@RequestBody WechatLoginRequest request) {
    // 请求体
    {
        "code": "微信授权码",
        "encryptedData": "加密数据",
        "iv": "初始向量"
    }
}

// 刷新Token
@PostMapping("/refresh-token")
public ResponseEntity<TokenResponse> refreshToken(@RequestBody RefreshTokenRequest request) {
    // 请求体
    {
        "refresh_token": "刷新令牌"
    }
}
```

### 5.2 任务接口
```java
// 获取任务列表
@GetMapping("/tasks")
public ResponseEntity<PageResult<TaskVO>> getTasks(
        @RequestParam(required = false) String type,
        @RequestParam(required = false) String userLevel,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size) {
    // 请求示例: GET /api/tasks?type=ad&user_level=normal&page=1&size=10
}

// 领取任务
@PostMapping("/user-tasks/claim")
public ResponseEntity<ClaimResult> claimTask(@RequestBody ClaimTaskRequest request) {
    // 请求体
    {
        "task_id": 123,
        "user_id": 456
    }
}

// 完成任务
@PostMapping("/user-tasks/{user_task_id}/complete")
public ResponseEntity<CompleteResult> completeTask(
        @PathVariable Long user_task_id,
        @RequestBody CompleteTaskRequest request) {
    // 请求体
    {
        "proof_data": {
            "ad_duration": 30,
            "completion_time": "2024-01-15T10:30:00Z"
        }
    }
}
```

### 5.3 收益接口
```java
// 获取收益统计
@GetMapping("/earnings/stats")
public ResponseEntity<EarningsStatsVO> getEarningsStats(
        @RequestParam Long userId,
        @RequestParam String period,
        @RequestParam(required = false) Integer year,
        @RequestParam(required = false) Integer month) {
    // 请求示例: GET /api/earnings/stats?user_id=456&period=month&year=2024&month=1
}

// 申请提现
@PostMapping("/withdrawals/apply")
public ResponseEntity<WithdrawalResult> applyWithdrawal(@RequestBody WithdrawalRequest request) {
    // 请求体
    {
        "user_id": 456,
        "amount": 1000,
        "withdraw_type": "wechat_pay"
    }
}
```

## 6. 业务流程

### 6.1 任务完成流程
```
用户领取任务 → 完成任务 → 广告主验证 → 收益计算 → 收益发放 → 用户提现
```

### 6.2 商城购买流程
```
用户浏览商品 → 选择商品 → 下单支付 → ERP处理订单 → 物流发货 → 订单完成
```

### 6.3 用户升级流程
```
用户完成任务 → 获得收益 → 商城消费 → 等级计算 → 等级提升 → 更多权益
```

## 7. 安全设计

### 7.1 数据安全
- 用户数据加密存储
- API接口权限控制
- 敏感信息脱敏处理

### 7.2 支付安全
- 微信支付安全验证
- 提现风控机制
- 异常交易监控

### 7.3 系统安全
- 接口限流和防刷
- 异常行为检测
- 系统监控和告警

## 8. 性能优化

### 8.1 数据库优化
- 索引优化
- 查询优化
- 分库分表策略

### 8.2 缓存策略
- Redis缓存热点数据
- 接口响应缓存
- 静态资源CDN

### 8.3 系统优化
- 异步处理任务
- 消息队列解耦
- 负载均衡

## 9. 监控和运维

### 9.1 系统监控
- 接口性能监控
- 数据库性能监控
- 系统资源监控

### 9.2 业务监控
- 任务完成率监控
- 收益发放监控
- 用户活跃度监控

### 9.3 日志管理
- 系统日志记录
- 业务日志分析
- 错误日志追踪

## 10. 部署架构

### 10.1 开发环境
- 本地开发环境
- 测试环境
- 预发布环境

### 10.2 生产环境
- 应用服务器集群
- 数据库主从复制
- 负载均衡器
- CDN加速

### 10.3 容器化部署
- Docker容器化
- Kubernetes编排
- 自动化部署
- 滚动更新

---

**文档版本**：v1.0  
**创建日期**：2024-01-15  
**最后更新**：2024-01-15
